(function(n,l){typeof exports=="object"&&typeof module<"u"?l(exports,require("@forminator/react-wire"),require("react")):typeof define=="function"&&define.amd?define(["exports","@forminator/react-wire","react"],l):(n=typeof globalThis<"u"?globalThis:n||self,l(n["react-wire-persisted"]={},n.reactWire,n.React))})(this,(function(n,l,f){"use strict";(function(){const s={};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,s);return}}catch{}globalThis.process={env:s}})();const S={},v=s=>{S[s]=s},P=s=>v(s),U=()=>S,R=(s,e=null)=>{const t=e||S;return s?Object.keys(t).reduce((r,o)=>({...r,[o]:`${s}.${t[o]}`}),{}):t},m={__IS_FAKE_LOCAL_STORAGE__:!0},_={getItem:s=>m[s],setItem:(s,e)=>{m[s]=e},removeItem:s=>{delete m[s]},...m};let I=!1,O=!1;typeof window<"u"&&(I=!0,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{O=!0}):O=!0);const h=()=>I,b=()=>O,p=()=>{if(!I)return!1;try{const s="__rwp_test__";return window.localStorage.setItem(s,"test"),window.localStorage.removeItem(s),!0}catch{return!1}},T=s=>{const e=typeof s;return s===null?!0:Array.isArray(s)||e==="object"?!1:e!=="function"},L=Object.freeze(Object.defineProperty({__proto__:null,addKey:v,fakeLocalStorage:_,getHasHydrated:b,getIsClient:h,getKeys:U,getPrefixedKeys:R,isLocalStorageAvailable:p,isPrimitive:T,key:P},Symbol.toStringTag,{value:"Module"}));class w{constructor(e,t){if(new.target===w)throw TypeError("StorageProvider is abstract. Extend this class to implement it");this.namespace=e||null,this.registry=t||{}}setNamespace(e){}register(e,t){this.registry[e]=t}getItem(e){}setItem(e,t){}removeItem(e,t=!1){}getAll(){}_resetAll(e=!0,t=[],r=!1){}resetAll(e=[]){}removeAll(e=[]){}}class F extends w{constructor(e=null,t={}){super(e,t),this.storage=this.getStorage(),this._isUsingFakeStorage=!p()}getStorage(){return p()?window.localStorage:_}setNamespace(e){if(!this.namespace){this.namespace=e;return}if(this.namespace===e)return;const t=JSON.parse(JSON.stringify(this.getAll()));this.removeAll();for(const[r,o]of Object.entries(t)){const i=r.replace(this.namespace,e);this.setItem(i,o)}this.namespace=e}getItem(e){const t=this.storage.getItem(e);if(t==null)return null;try{return JSON.parse(t)}catch{return t}}setItem(e,t){let r=t;return r!=null&&(r=T(t)?t:JSON.stringify(t)),this.storage.setItem(e,r)}removeItem(e,t=!1){return t&&delete this.registry[e],this.storage.removeItem(e)}getAll(){const e=`${this.namespace}.`;return Object.keys(this.storage).reduce((t,r)=>((!this.namespace||r.startsWith(e))&&(t[r]=this.storage.getItem(r)),t),{})}_resetAll(e=!0,t=[],r=!1){const o=`${this.namespace}.`;Object.keys(this.storage).forEach(i=>{const c=this.namespace?i.startsWith(o):!0,g=t?.includes(i)||!1;!c||g||(e?Object.prototype.hasOwnProperty.call(this.registry,i)?this.storage.setItem(i,this.registry[i]):this.storage.removeItem(i):(this.storage.removeItem(i),r&&delete this.registry[i]))})}resetAll(e=[],t=!1){this._resetAll(!0,e||[],t)}removeAll(e=[],t=!1){this._resetAll(!1,e||[],t)}upgradeToRealStorage(){if(!this._isUsingFakeStorage||!p())return!1;const e={...this.storage};return this.storage=window.localStorage,this._isUsingFakeStorage=!1,Object.keys(e).forEach(t=>{if(t!=="__IS_FAKE_LOCAL_STORAGE__"&&e[t]!=null)try{this.storage.setItem(t,e[t])}catch{return this.storage=_,this._isUsingFakeStorage=!0,!1}}),!0}isUsingFakeStorage(){return this._isUsingFakeStorage}}const j={logging:{enabled:!1}};let E=F,a=new E,u={...j},y=[];const K=()=>a.namespace,k=()=>a,H=()=>u,W=s=>{a.setNamespace(s),a=new E(s||K())},V=s=>{if(u={...u,...s},u.logging.enabled)for(console.info("Flushing",y.length,"pending logs");y.length;)console.log(...y.shift())},A=()=>{if(!h())return!1;const s=a.upgradeToRealStorage();return s&&N("react-wire-persisted: Upgraded to real localStorage after hydration"),s},N=(...s)=>{u.logging.enabled?console.log(...s):y.push(s)},$=(s,e=null)=>{if(!s&&typeof s!="number")throw new Error(`createPersistedWire: Key cannot be a falsey value (${s}}`);a.register(s,e);const t=l.createWire(e),r=()=>t.getValue(),o=d=>(a.setItem(s,d),t.setValue(d)),i=d=>{t.subscribe(d)},c=a.getItem(s),g=c===null?e:c;return N("react-wire-persisted: create",s,{value:e,storedValue:c,initialValue:g}),g!==e&&o(g),{...t,getValue:r,setValue:o,subscribe:i}},C=(s={})=>{const{autoUpgrade:e=!0,onUpgrade:t}=s,r=f.useRef(!1);return f.useEffect(()=>{if(!e||r.current||!h())return;const o=()=>{b()&&!r.current&&A()&&(r.current=!0,t?.())};o();const i=setTimeout(o,0);return()=>clearTimeout(i)},[e,t]),{hasUpgraded:r.current}};function J({children:s,onUpgrade:e,autoUpgrade:t=!0}){const r=f.useRef(!1);return f.useEffect(()=>{if(!t||r.current||!h())return;const o=()=>{b()&&!r.current&&A()&&(r.current=!0,e?.())};o();const i=setTimeout(o,0);return()=>clearTimeout(i)},[t,e]),s}n.HydrationProvider=J,n.createPersistedWire=$,n.defaultOptions=j,n.getNamespace=K,n.getOptions=H,n.getStorage=k,n.setNamespace=W,n.setOptions=V,n.upgradeStorage=A,n.useHydration=C,n.utils=L,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})}));
