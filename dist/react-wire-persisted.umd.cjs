(function(n,d){typeof exports=="object"&&typeof module<"u"?d(exports,require("react"),require("@forminator/react-wire")):typeof define=="function"&&define.amd?define(["exports","react","@forminator/react-wire"],d):(n=typeof globalThis<"u"?globalThis:n||self,d(n["react-wire-persisted"]={},n.React,n.reactWire))})(this,(function(n,d,F){"use strict";(function(){const e={};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,e);return}}catch{}globalThis.process={env:e}})();const m={__IS_FAKE_LOCAL_STORAGE__:!0},y={getItem:e=>m[e],setItem:(e,t)=>{m[e]=t},removeItem:e=>{delete m[e]},...m};let W=!1,b=!1,U=!1;typeof window<"u"&&(W=!0,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{b=!0}):b=!0);const h=()=>W,w=()=>b,P=()=>U,v=()=>{U=!0},I=()=>{if(!W)return!1;try{const e="__rwp_test__";return window.localStorage.setItem(e,"test"),window.localStorage.removeItem(e),!0}catch{return!1}},E={},G=e=>{E[e]=e},j=e=>G(e),H=()=>E,K=(e,t=null)=>{const s=t||E;return e?Object.keys(s).reduce((r,l)=>(r[l]=`${e}.${s[l]}`,r),{}):s},L=e=>{const t=typeof e;return e===null?!0:Array.isArray(e)||t==="object"?!1:t!=="function"},V=Object.freeze(Object.defineProperty({__proto__:null,addKey:G,fakeLocalStorage:y,getHasHydrated:w,getHasHydratedStorage:P,getIsClient:h,getKeys:H,getPrefixedKeys:K,isLocalStorageAvailable:I,isPrimitive:L,key:j,markStorageAsHydrated:v},Symbol.toStringTag,{value:"Module"}));class T{constructor(t,s){if(new.target===T)throw TypeError("StorageProvider is abstract. Extend this class to implement it");this.namespace=t||null,this.registry=s||{}}setNamespace(t){}register(t,s){this.registry[t]=s}getItem(t){}setItem(t,s){}removeItem(t,s=!1){}getAll(){}_resetAll(t=!0,s=[],r=!1){}resetAll(t=[]){}removeAll(t=[]){}}class C extends T{constructor(t=null,s={}){super(t,s),this.storage=y,this._isUsingFakeStorage=!0}getStorage(){return I()?window.localStorage:y}setNamespace(t){if(!this.namespace){this.namespace=t;return}if(this.namespace===t)return;const s=JSON.parse(JSON.stringify(this.getAll()));this.removeAll();for(const[r,l]of Object.entries(s)){const a=r.replace(this.namespace,t);this.setItem(a,l)}this.namespace=t}getItem(t){const s=this.storage.getItem(t);if(s==null)return null;try{return JSON.parse(s)}catch{return s}}setItem(t,s){let r=s;return r!=null&&(r=L(s)?s:JSON.stringify(s)),this.storage.setItem(t,r)}removeItem(t,s=!1){return s&&delete this.registry[t],this.storage.removeItem(t)}getAll(){const t=`${this.namespace}.`;return Object.keys(this.storage).reduce((s,r)=>((!this.namespace||r.startsWith(t))&&(s[r]=this.storage.getItem(r)),s),{})}_resetAll(t=!0,s=[],r=!1){const l=`${this.namespace}.`;Object.keys(this.storage).forEach(a=>{const u=this.namespace?a.startsWith(l):!0,R=s?.includes(a)||!1;!u||R||(t?Object.hasOwn(this.registry,a)?this.storage.setItem(a,this.registry[a]):this.storage.removeItem(a):(this.storage.removeItem(a),r&&delete this.registry[a]))})}resetAll(t=[],s=!1){this._resetAll(!0,t||[],s)}removeAll(t=[],s=!1){this._resetAll(!1,t||[],s)}upgradeToRealStorage(){return!this._isUsingFakeStorage||!I()?!1:(this.storage=window.localStorage,this._isUsingFakeStorage=!1,!0)}isUsingFakeStorage(){return this._isUsingFakeStorage}}const g=Math.random().toString(36).substring(7),i=(...e)=>{typeof globalThis<"u"&&globalThis.__RWP_LOGGING_ENABLED__!==!1&&console.log(...e)},A={logging:{enabled:!1}};typeof globalThis<"u"&&globalThis.__RWP_LOGGING_ENABLED__===void 0&&(globalThis.__RWP_LOGGING_ENABLED__=A.logging.enabled),i("[RWP] Module initialized, instance ID:",g);const O=C;i("[RWP] About to check global storage, instanceId:",g);let o;try{globalThis.__RWP_STORAGE__?i("[RWP] Using existing global storage in instance:",g):(i("[RWP] Creating global storage in instance:",g),globalThis.__RWP_STORAGE__=new O),o=globalThis.__RWP_STORAGE__,i("[RWP] Storage assigned successfully")}catch(e){globalThis.__RWP_LOGGING_ENABLED__&&console.error("[RWP] Error setting up global storage:",e),o=new O}let p={...A};const S=[];typeof globalThis<"u"&&(globalThis.__RWP_REGISTERED_WIRES__?i("[RWP] Using existing global registeredWires in instance:",g):(i("[RWP] Creating global registeredWires in instance:",g),globalThis.__RWP_REGISTERED_WIRES__=new Map));const c=globalThis.__RWP_REGISTERED_WIRES__||new Map;i("[RWP] registeredWires Map reference in instance:",g,"size:",c.size);const k=()=>o.namespace,D=()=>o,z=()=>p,M=e=>{i("[RWP] setNamespace() called with:",e,"registered wires before:",c.size),o.setNamespace(e),o=new O(e||k()),i("[RWP] setNamespace() done, registered wires after:",c.size)},$=e=>{if(p={...p,...e},typeof globalThis<"u"&&(globalThis.__RWP_LOGGING_ENABLED__=p.logging.enabled),p.logging.enabled)for(console.info("Flushing",S.length,"pending logs");S.length;)console.log(...S.shift())},B=()=>{i("[RWP] refreshAllWires() called in instance:",g,"registered wires:",c.size),_("react-wire-persisted: refreshAllWires() called, registered wires:",c.size),c.forEach((e,t)=>{const s=o.getItem(t),r=e.getValue();i("[RWP] Checking wire",t,{storedValue:s,currentValue:r,willUpdate:s!==null&&s!==r}),_("react-wire-persisted: Checking wire",t,{storedValue:s,currentValue:r,willUpdate:s!==null&&s!==r}),s!==null&&s!==r&&(i("[RWP] Refreshing wire",t,"with stored value",s),_("react-wire-persisted: Refreshing wire",t,"with stored value",s),e.setValue(s))})},N=()=>{if(i("[RWP] upgradeStorage() called in instance:",g,{isClient:h(),isUsingFakeStorage:o.isUsingFakeStorage()}),_("react-wire-persisted: upgradeStorage() called",{isClient:h(),isUsingFakeStorage:o.isUsingFakeStorage()}),!h())return!1;const e=o.upgradeToRealStorage();return i("[RWP] upgradeToRealStorage() returned",e),_("react-wire-persisted: upgradeToRealStorage() returned",e),e&&(v(),i("[RWP] Upgraded to real localStorage, calling refreshAllWires()"),_("react-wire-persisted: Upgraded to real localStorage after hydration"),B()),e},_=(...e)=>{p.logging.enabled?console.log(...e):S.push(e)},x=(e,t=null)=>{if(i("[RWP] createPersistedWire() called in instance:",g,"key:",e,"value:",t),!e&&typeof e!="number")throw new Error(`createPersistedWire: Key cannot be a falsey value (${e}}`);o.register(e,t);const s=F.createWire(t),r=()=>s.getValue(),l=f=>(i("[RWP] setValue called in instance:",g,"key:",e,"isUsingFakeStorage:",o.isUsingFakeStorage()),o.setItem(e,f),s.setValue(f)),a=f=>{s.subscribe(f)};let u=t;const R=P()||!o.isUsingFakeStorage();if(R&&h()){const f=o.getItem(e);f!==null&&(u=f)}return _("react-wire-persisted: create",e,{value:t,initialValue:u,hasHydratedStorage:P(),isUsingFakeStorage:o.isUsingFakeStorage(),canReadStorage:R}),u!==t&&l(u),c.set(e,{getValue:r,setValue:l,subscribe:a}),i("[RWP] Wire registered, total wires:",c.size,"keys:",Array.from(c.keys())),{...s,getValue:r,setValue:l,subscribe:a}};function J({children:e,onUpgrade:t,autoUpgrade:s=!0}){const r=d.useRef(!1);return d.useEffect(()=>{if(!s||r.current||!h())return;const l=()=>{w()&&!r.current&&N()&&(r.current=!0,t?.())};l();const a=setTimeout(l,0);return()=>clearTimeout(a)},[s,t]),e}const q=(e={})=>{const{autoUpgrade:t=!0,onUpgrade:s}=e,r=d.useRef(!1);return d.useEffect(()=>{if(!t||r.current||!h())return;const l=()=>{w()&&!r.current&&N()&&(r.current=!0,s?.())};l();const a=setTimeout(l,0);return()=>clearTimeout(a)},[t,s]),{hasUpgraded:r.current}};n.HydrationProvider=J,n.createPersistedWire=x,n.defaultOptions=A,n.getNamespace=k,n.getOptions=z,n.getStorage=D,n.setNamespace=M,n.setOptions=$,n.upgradeStorage=N,n.useHydration=q,n.utils=V,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})}));
